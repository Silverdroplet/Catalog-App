{% extends "base.html" %}

{% block title %}Equipment Catalog{% endblock %}

{% block content %}
<h1 class="mb-4">Equipment Catalog</h1>

{% if not items %}
<p>No equipment to display</p>
{% endif %}

<a class="btn btn-primary btn-lg mx-3" href="{% url 'core:collection_catalog' %}">View Collection Catalog</a>
<br>
{% if user.is_authenticated and user.profile.is_librarian %}
  <a href="{% url 'core:add_equipment' %}" class="btn btn-success mb-3">
    Add New Equipment
  </a>
{% endif %}

<form method="get" class="mb-4">
  <label for="location" class="form-label"><strong>Filter by Gym Location:</strong></label>
  <select name="location" id="location" class="form-select" onchange="this.form.submit()">
    <option value="">All Locations</option>
    {% for loc in gyms %}
      {% if loc %}
        <option value="{{ loc }}" {% if request.GET.location == loc %}selected{% endif %}>{{ loc }}</option>
      {% endif %}
    {% endfor %}
  </select>
</form>

<ul class="list-unstyled">
  {% for item in items %}
    <li class="mb-5 border-bottom pb-3">
      <h4>{{ item.name }}</h4>
      
      <!-- Images -->
      <div class="mb-2">
        {% for image_obj in item.images.all %}
          <img 
            src="{{ image_obj.image.url }}" 
            alt="{{ item.name }}" 
            width="150" 
            class="img-thumbnail me-2 mb-2"
          >
          {% if image_obj.caption %}
            <p>{{ image_obj.caption }}</p>
          {% endif %}
        {% empty %}
          <em>No images available</em>
        {% endfor %}
      </div>

      <!-- Equipment Details -->
      <p><strong>Identifier:</strong> {{ item.identifier }}</p>
      <p><strong>Description:</strong> {{ item.description }}</p>
      <p><strong>Location:</strong> {{ item.location }}</p>

      <!-- Status with Emojis -->
      <p>
        <strong>Status:</strong>
        {% if item.status == "checked-in" %}
          <span class="text-success">‚úÖ Checked In</span>
        {% elif item.status == "in-circulation" %}
          <span class="text-warning">üîÑ In Circulation</span>
        {% elif item.status == "being-repaired" %}
          <span class="text-danger">üîß Being Repaired</span>
        {% else %}
          {{ item.status }}
        {% endif %}
      </p>

      <!-- Availability with Emojis -->
      <p>
        <strong>Availability:</strong>
        {% if item.is_available %}
          <span class="text-success">‚úÖ Available</span>
        {% else %}
          <span class="text-danger">‚ùå Loaned Out</span>
        {% endif %}
      </p>

      <!-- Librarian Actions -->
      {% if user.is_authenticated and user.profile.is_librarian %}
        <a href="{% url 'core:edit_equipment' item.id %}" class="btn btn-info me-2">
          Edit
        </a>
        <a href="{% url 'core:delete_equipment' item.id %}" class="btn btn-danger">
          Delete
        </a>
      {% endif %}
    </li>

      <!-- Reviews Section -->
      <h5>Reviews</h5>
      {% with item_reviews=reviews|dictsort:"-created_at" %}
        {% for review in reviews %}
          {% if review.equipment == item %}
            <p><strong>{{ review.user.username }}</strong> rated it {{ review.rating }}/5</p>
            <p>{{ review.comment }}</p>
            <hr>
          {% endif %}
        {% empty %}
          <p>No reviews yet. Be the first to review this item!</p>
        {% endfor %}
      {% endwith %}

      <!-- Submit a Review -->
      {% if user.is_authenticated %}
        <form method="POST" action="{% url 'core:submit_review' item.id %}">
          {% csrf_token %}
          
          <!-- Rating Selection -->
          <label for="rating"><strong>Rating (1-5):</strong></label>
          <select name="rating" class="form-select" required>
            <option value="1">1 - Poor</option>
            <option value="2">2 - Fair</option>
            <option value="3">3 - Good</option>
            <option value="4">4 - Very Good</option>
            <option value="5">5 - Excellent</option>
          </select>

          <!-- Review Comment -->
          <label for="comment"><strong>Comment:</strong></label>
          <textarea name="comment" class="form-control" rows="3"></textarea>

          <button type="submit" class="btn btn-primary mt-2">Submit Review</button>
        </form>
      {% else %}
        <p><a href="{% url 'core:login' %}">Log in</a> to leave a review.</p>
      {% endif %}
  {% endfor %}
</ul>

<a href="{% url 'core:home' %}" class="btn btn-primary btn-lg mx-3">Back to Home</a>
{% endblock %}
