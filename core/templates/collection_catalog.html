{% extends 'base.html' %}

{% block content %}
    <h1>Catalog</h1>

    <!-- Search Form -->
    <form method="GET" action="{% url 'core:collection_catalog' %}">
        <input type="text" name="q" placeholder="Search collections..." value="{{ query }}">
        <button type="submit">Search</button>
    </form>

    <ul>
        {% for collection in collections %}
            <li>
                {% if collection.visibility == 'public' %}
                    <h2>{{ collection.title }}</h2>
                    <p>Description: {{ collection.description }}</p>
                    <p>Visibility: Public</p>
                    <p>Items</p>
                    {% for item in collection.items.all %}
                    <li>
                        <strong>{{ item.name }}</strong>
                    </li>
                    {% empty %}
                            <p>No items in this collection.</p>
                    {% endfor %}
                    <a href="{% url 'core:view_collection' collection.id %}">View Collection</a>
                {% else %}
                {% if user.is_authenticated %}
                    <h2>{{ collection.title }}</h2>
                    {% if user in collection.access_requests.all %}
                        <p><em>(Private collection, details hidden)</em></p>
                        <p>Your request to access this collection is pending approval.</p>
                    {% elif user in collection.allowed_users.all or collection.creator == request.user %}
                        <p><em>(Private collection, You have access)</em></p>
                        <p>Description: {{ collection.description }}</p>
                        <p>Items</p>
                        {% for item in collection.items.all %}
                        <li>
                            <strong>{{ item.name }}</strong>
                        </li>
                        {% empty %}
                            <p>No items in this collection.</p>
                        {% endfor %}
                        <a href="{% url 'core:view_collection' collection.id %}">View Collection</a>
                    {% else %}
                        <p><em>(Private collection, details hidden)</em></p>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="collection_id" value="{{ collection.id }}">
                            <button type="submit" name="request_access">Request Access</button>
                        </form>
                    {% endif %}
                {% endif %}
                {% endif %}
                {% if user.profile.is_librarian or collection.creator == request.user %}
                <a href="{% url 'core:edit_collection' collection.id %}">Edit This Collection</a>
                <form method="POST" action="{% url 'core:delete_collection' collection.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('Are you sure you want to delete this collection?')" 
                            class="btn btn-danger">Delete</button>
                </form>
                {% endif %}
            </li>
        {% empty %}
            <p>No collections found.</p>
        {% endfor %}
    </ul>
{% endblock %}
