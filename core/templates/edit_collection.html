{% extends "base.html" %}

{% block title %}Edit Collection{% endblock %}

{% block content %}
<h2>Edit Collection: {{ collection.title }}</h2>

<form method="post">
  {% csrf_token %}

  <p><label for="{{ form.title.id_for_label }}">Title:</label> {{ form.title }}</p>
  <p><label for="{{ form.description.id_for_label }}">Description:</label> {{ form.description }}</p>
  
  {% if form.visibility %}
      <p><label for="{{ form.visibility.id_for_label }}">Visibility:</label> {{ form.visibility }}</p>
  {% endif %}
  
  <fieldset>
    <legend>Select Items to Edit:</legend>
    {% for item in form.items.field.queryset %}
        <label>
            <input type="checkbox" name="items" value="{{ item.id }}"
            {% if collection and item in collection.items.all %}checked{% endif %}>
            <strong>{{ item.name }}</strong> ({{ item.status }})
            <small>ID: {{ item.identifier }}, </small>
            <small>Description: {{ item.description }}, </small>
            <small>Location: {{ item.location }}</small>
        </label><br>
    {% endfor %}
  </fieldset>
  {% if user.profile.is_librarian %}
  <fieldset id="allowed-users-fieldset" style="display: none;">
    <legend>Select Users Allowed to Access (Librarians Already Have Access):</legend>
    {% for user in form.allowed_users.field.queryset %}
        <label>
            <input type="checkbox" name="allowed_users" value="{{ user.id }}" 
            {% if user in form.instance.allowed_users.all %}checked{% endif %}>
            {{ user.username }} ({{ user.email }})
        </label><br>
    {% endfor %}
  </fieldset>
  {% endif %}

  <button type="submit">Edit Collection</button>
</form>

<a href="{% url 'core:my_collections' %}">Back to My Collections</a>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      var visibilityField = document.getElementById("{{ form.visibility.id_for_label }}");
      var allowedUsersFieldset = document.getElementById("allowed-users-fieldset");

      function toggleAllowedUsers() {
          if (visibilityField.value === "private") {
              allowedUsersFieldset.style.display = "block";
          } else {
              allowedUsersFieldset.style.display = "none";
          }
      }

      toggleAllowedUsers();

      visibilityField.addEventListener("change", toggleAllowedUsers);
  });
</script>
{% endblock %}