{% extends "base.html" %}

{% block title %}Add A Collection!{% endblock %}

{% block content %}
<h2>Add a New Collection</h2>

<form method="post">
  {% csrf_token %}

  <p><label for="{{ form.title.id_for_label }}">Title:</label> {{ form.title }}</p>
  <p><label for="{{ form.description.id_for_label }}">Description:</label> {{ form.description }}</p>
  
  {% if form.visibility %}
      <p><label for="{{ form.visibility.id_for_label }}">Visibility:</label> {{ form.visibility }}</p>
  {% endif %}
  
  <fieldset>
    <legend>Select Items to Add:</legend>
    {% for item in form.items.field.queryset %}
        <label>
            <input type="checkbox" name="items" value="{{ item.id }}">
            <strong>{{ item.name }}</strong> ({{ item.status }})
            <small>ID: {{ item.identifier }}, </small>
            <small>Description: {{ item.description }}, </small>
            <small>Location: {{ item.location }}</small>
        </label><br>
    {% endfor %}
  </fieldset>
  {% if user.profile.is_librarian %}
    <fieldset id="allowed-users-fieldset" style="display: none;">
    <legend>Select Users Allowed to Access (Librarians Already Have Access):</legend>

    <input type="text" id="user-search" placeholder="Search users..." style="margin-bottom: 10px;">

    <div id="allowed-users-list">
        {% for user in form.allowed_users.field.queryset %}
            <label class="user-entry">
                <input type="checkbox" name="allowed_users" value="{{ user.id }}">
                {{ user.username }} ({{ user.email }})<br>
            </label>
        {% endfor %}
    </div>
    </fieldset>
{% endif %}


  <button type="submit">Create Collection</button>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var visibilityField = document.getElementById("{{ form.visibility.id_for_label }}");
        var allowedUsersFieldset = document.getElementById("allowed-users-fieldset");
  
        function toggleAllowedUsers() {
            allowedUsersFieldset.style.display = visibilityField.value === "private" ? "block" : "none";
        }
  
        toggleAllowedUsers();
        visibilityField.addEventListener("change", toggleAllowedUsers);

        var userSearchInput = document.getElementById("user-search");
        var userLabels = document.querySelectorAll("#allowed-users-list .user-entry");
        userLabels.forEach(function (label) {
            label.style.display = "none";
        });
        userSearchInput.addEventListener("input", function () {
    var searchTerm = this.value.toLowerCase();

    if (searchTerm.length < 3) {
        userLabels.forEach(function (label) {
            label.style.display = "none";
        });
    } else {
        userLabels.forEach(function (label) {
            var text = label.textContent.toLowerCase();
            label.style.display = text.includes(searchTerm) ? "block" : "none";
        });
    }
});
    });
  </script>
{% endblock %}