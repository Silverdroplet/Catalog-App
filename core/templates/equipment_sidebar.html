{% load socialaccount %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<h5>{{ item.name }}</h5>
<p><strong>Identifier:</strong> {{ item.identifier }}</p>
<p>{{ item.description|default:"No description available." }}</p>
<p><strong>Location:</strong> {{ item.location }}</p>
<p><strong>Sport:</strong> {{ item.sports_type|default:"N/A" }}</p>
<p><strong>Status:</strong> {{ item.get_status_display }}</p>
<p><strong>Available:</strong> {{ item.is_available|yesno:"✅ Yes,❌ No" }}</p>

<h5 class="mt-3">Reviews</h6>
{% for review in reviews %}
  <p><strong>{{ review.user.username }}</strong> rated it {{ review.rating }}/5</p>
  <p>{{ review.comment }}</p>
  <hr>
{% empty %}
  <p>No reviews yet.</p>
{% endfor %}

<h5 class="mt-3">Leave a Review</h6>
<!-- Submit a Review -->
{% if request.user.is_authenticated %}
<form method="POST" action="{% url 'core:submit_review' item.id %}">
  {% csrf_token %}
  
  <div class="mb-3">
    <label for="rating" class="form-label"><strong>Rating (1-5):</strong></label>
    <select name="rating" id="rating" class="form-select" required>
      <option value="1">1 - Poor</option>
      <option value="2">2 - Fair</option>
      <option value="3">3 - Good</option>
      <option value="4">4 - Very Good</option>
      <option value="5">5 - Excellent</option>
    </select>
  </div>

  <!-- Review Comment -->
  <div class="mb-3">
    <label for="comment" class="form-label"><strong>Comment:</strong></label>
    <textarea name="comment" id="comment" class="form-control" rows="3" placeholder="Write your review here..."></textarea>
  </div>

  <button type="submit" class="btn btn-primary mt-2">Submit Review</button>
  <br><br>
</form>
{% else %}
<a class="btn btn-primary" href="{% provider_login_url 'google' %}">Login to Leave a Review</a>
<br>
{% endif %}

<!-- Borrow Button -->
{% if request.user.is_authenticated %}
  {% if item.is_available %}
    <form method="POST" action="{% url 'core:borrow_item' item.id %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-success">Borrow Item</button>
    </form>
  {% elif not item.is_available and loan and loan.user == request.user %}
    <form method="POST" action="{% url 'core:return_item' item.id %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-success">Return Item</button>
    </form>
  {% else %}
    <button class="btn btn-secondary" disabled>Not Available</button>
    <br>
  {% endif %}
{% endif %}
{% if request.user.is_authenticated %}
<button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#addToCollectionModal">
  Add to a Collection
</button>


<div class="modal fade" id="addToCollectionModal" role="dialog" tabindex="-1" aria-labelledby="addToCollectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{% url 'core:add_item_to_collection' item.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addToCollectionModalLabel">Add {{ item.name }} to a Collection</h5>
          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {% if collections %}
            <label for="collectionSelect" class="form-label">Select Collection</label>
            <select class="form-select" id="collectionSelect" name="collection_id" required>
              {% for collection in collections %}
                {% if collection.visibility == 'public' %}
                  <option value="{{ collection.id }}">{{ collection.title }}</option>
                {% else %}
                  {% if request.user in collection.allowed_users.all %}
                    <option value="{{ collection.id }}">{{ collection.title }}</option>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </select>
            {% endif %}
            {% if not collections %}
            <label for="collectionSelect" class="form-label">You have no collections.</label>
            <br>
            <a href="{% url 'core:add_collection' %}" class="btn btn-primary">Add New Collection</a>
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endif %}
<!-- Librarian Actions -->
{% if request.user.is_authenticated and request.user.profile.is_librarian %}
  <div class="mt-3">
    <a href="{% url 'core:edit_equipment' item.id %}" class="btn btn-warning me-2">Edit</a>
    <a href="{% url 'core:delete_equipment' item.id %}" class="btn btn-danger">Delete</a>
  </div>
{% endif %}